name: Docker Build CI

on:
  workflow_dispatch:
  release:
    types: [published]

env:
  IMAGE_NAME: ${{ github.repository }}
  IMAGE_TAG: ${{ github.sha }}


jobs:

  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [ linux/amd64, linux/arm64 ]
    steps:
    -
        name: Check out the repo
        uses: actions/checkout@v3
    -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
    -
      name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    -
      name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    -
      name: Build and push
      uses: docker/build-push-action@v4
      with:
        push: true
        platforms: ${{ matrix.platform }}
        tags: ${{ env.IMAGE_NAME }}:${{env.IMAGE_TAG}},${{ env.IMAGE_NAME }}:latest
        #tags: qiyuanqwe/midjourney-api:1.0-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64v8' }}

#  manifest:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#    -
#      name: Create and push manifest
#      run: |
#        docker manifest create qiyuanqwe/midjourney-api:1.0 \
#          --amend qiyuanqwe/midjourney-api:1.0-amd64 \
#          --amend qiyuanqwe/midjourney-api:1.0-arm64v8
#        docker manifest push qiyuanqwe/midjourney-api:1.0
#      env:
#        DOCKER_CLI_EXPERIMENTAL: enabled